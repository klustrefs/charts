name: Create Release from Tag

on:
  push:
    tags:
      - "*"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      chart: ${{ steps.parse.outputs.chart }}
      version: ${{ steps.parse.outputs.version }}
      tag: ${{ steps.parse.outputs.tag }}
    steps:
      - name: Parse chart tag
        id: parse
        shell: bash
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          TAG="${TAG_NAME}"
          regex='^([a-zA-Z0-9._-]+)-(v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?)$'
          if [[ $TAG =~ $regex ]]; then
            chart="${BASH_REMATCH[1]}"
            version="${BASH_REMATCH[2]}"
          else
            echo "Tag '$TAG' must look like <chart-name>-<semver> (e.g., klustre-csi-plugin-0.1.0)" >&2
            exit 1
          fi
          clean_version="${version#v}"
          echo "chart=$chart" >> "$GITHUB_OUTPUT"
          echo "version=$clean_version" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  ci-checks:
    needs: prepare
    uses: ./.github/workflows/ci.yaml
    secrets: inherit
    with:
      chart: ${{ needs.prepare.outputs.chart }}

  create-release:
    needs: [prepare, ci-checks]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --tag ${{ needs.prepare.outputs.tag }}
        env:
          OUTPUT: RELEASE_NOTES.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load release notes
        id: notes
        run: |
          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          cat RELEASE_NOTES.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: actions/github-script@v7
        env:
          RELEASE_NOTES: ${{ steps.notes.outputs.RELEASE_NOTES }}
        with:
          script: |
            const tag = '${{ needs.prepare.outputs.tag }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = process.env.RELEASE_NOTES ?? '';

            try {
              const release = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: tag,
                body
              });
              core.info(`Created release ${release.data.html_url}`);
            } catch (error) {
              const errors = error.response?.data?.errors ?? [];
              const alreadyExists = errors.some((item) => item.code === 'already_exists');

              if (error.status === 422 && alreadyExists) {
                core.info(`Release for ${tag} already exists, skipping creation.`);
              } else {
                throw error;
              }
            }

  publish-chart:
    needs: [prepare, ci-checks, create-release]
    uses: ./.github/workflows/publish.yml
    secrets: inherit
    with:
      chart: ${{ needs.prepare.outputs.chart }}
      version: ${{ needs.prepare.outputs.version }}
      tag: ${{ needs.prepare.outputs.tag }}
